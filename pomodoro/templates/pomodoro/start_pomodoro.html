{% extends "base.html" %}
{% load static %}
{% block title %}Pomodoro Başlat{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Sora', sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: start;
        background: linear-gradient(to right, #ffdee9, #b5fffc);
        transition: background 0.5s ease;
    }

    body.dark-mode {
        background: linear-gradient(to right, #1f0036, #000000);
    }

    .container {
        margin-top: 80px;
        background: linear-gradient(135deg, #ffffff, #d1b4ff);
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        color: #333;
    }
    .dark-mode .container {
        background: linear-gradient(135deg, #2d004d, #1c1c1c);
        color: #fff;
    }
    .btn {
        font-family: 'Sora', sans-serif;
        padding: 10px 50px;
        border-radius: 10px;
        font-size: 20px;
        cursor: pointer;
    }
    .progress {
        width: 100%;
        background-color: #e3ebfd;
        border-radius: 10px;
        overflow: hidden;
        height: 20px;
    }
    .progress-bar {
        height: 100%;
        background-color: #6a00f4;
        width: 0%;
        transition: width 0.3s;
    }
    .history {
        margin-bottom: 80px;
    }
</style>

<img src="{% static 'images/focuzon_logo_.png' %}" alt="Focuzon Logo" class="focuzon-logo">

<div class="container">
    <h2 class="section-title">Pomodoro Sayaç</h2>
    <p class="sub-text">Seçtiğin süre boyunca odaklan ve üretkenliğini artır! </p>

    <form method="POST" id="pomodoro-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="id_duration" class="fw-bold">Çalışma Süresi Seç:</label>
            <select id="id_duration" class="form-control">
                <option value="">-- Süre Seç --</option>
                <option value="5">5 Dakika</option>
                <option value="10">10 Dakika</option>
                <option value="15">15 Dakika</option>
                <option value="20">20 Dakika</option>
                <option value="25">25 Dakika</option>
                <option value="30">30 Dakika</option>
            </select>
        </div>
        <button type="button" class="btn btn-success mt-3 w-100" id="startBtn">🚀 Başlat</button>
    </form>

    <h2 id="timer" class="fw-bold mt-4">00:00</h2>

    <div class="controls">
        <button id="pauseBtn" class="btn btn-warning w-100 mt-2" style="display: none;">⏸ Duraklat</button>
        <button id="resumeBtn" class="btn btn-primary w-100 mt-2" style="display: none;">▶ Devam Et</button>
        <button id="completeBtn" class="btn btn-danger w-100 mt-2" style="display: none;">🛑 Çalışmayı Bitir</button>
    </div>

    <div class="progress mt-3">
       <div id="progressBar" class="progress-bar" role="progressbar"></div>
    </div>
    <div id="successMessage" style="display:none; margin-top:20px; font-size:18px; color:#6a00f4;">
        🎉 Harika! Odaklanma süreni tamamladın!
    </div>

    <div class="history text-center mt-5">
    <h3>📜 Geçmiş Oturumlar</h3>
    <ul>
        {% for session in past_sessions %}
            <li>
                ✅ {{ session.start_time|date:"d M Y H:i" }} -
                {{ session.duration }} odaklanıldı ({{ session.formatted_duration }})
            </li>
        {% empty %}
            <li>Henüz kayıtlı oturum yok.</li>
        {% endfor %}
    </ul>
    <button id="clearSessions" class="btn btn-danger mt-3">Geçmiş Oturumları Sil</button>
    <a href="{% url 'dashboard' %}" class="btn btn-primary mt-4">📊 Dashboard'a Git</a>
</div>

</div>

<input type="hidden" id="session_id" value="">

<script>
let timer;
let timeLeft = 0;
let isRunning = false;
let elapsedTime = 0;
let sessionId = null;

document.addEventListener("DOMContentLoaded", () => {
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const resumeBtn = document.getElementById("resumeBtn");
    const completeBtn = document.getElementById("completeBtn");
    const durationSelect = document.getElementById("id_duration");
    const timerDisplay = document.getElementById("timer");
    const successMessage = document.getElementById("successMessage");
    const progressBar = document.getElementById("progressBar");

    // Başlat butonu
    startBtn.addEventListener("click", () => {
        const duration = parseInt(durationSelect.value);
        if (!duration || isNaN(duration)) return alert("Lütfen süre seçin!");

        timeLeft = duration * 60;
        elapsedTime = 0;
        updateDisplay();
        updateProgress();

        fetch("/pomodoro/start/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body: JSON.stringify({ duration })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "started") {
                sessionId = data.session_id;
                startCountdown();
                startBtn.style.display = "none";
                pauseBtn.style.display = "block";
                completeBtn.style.display = "block";
            } else {
                alert(data.message || "Başlatılamadı.");
            }
        });
    });

    // Duraklat
    pauseBtn.addEventListener("click", () => {
        clearInterval(timer);
        pauseBtn.style.display = "none";
        resumeBtn.style.display = "block";
    });

    // Devam et
    resumeBtn.addEventListener("click", () => {
        resumeBtn.style.display = "none";
        pauseBtn.style.display = "block";
        startCountdown();
    });

    // Çalışmayı Bitir
    completeBtn.addEventListener("click", () => {
        clearInterval(timer);

        fetch(`/pomodoro/complete/${sessionId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            },
            body: JSON.stringify({ elapsed_time: elapsedTime })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "completed") {
                successMessage.style.display = "block";
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
                completeBtn.style.display = "none";
            } else {
                alert(data.message || "Bir hata oluştu.");
            }
        });
    });

    function startCountdown() {
        timer = setInterval(() => {
            timeLeft--;
            elapsedTime++;
            updateDisplay();
            updateProgress();
            if (timeLeft <= 0) {
                clearInterval(timer);
                completeBtn.click();
            }
        }, 1000);
    }

    function updateDisplay() {
        const minutes = String(Math.floor(timeLeft / 60)).padStart(2, "0");
        const seconds = String(timeLeft % 60).padStart(2, "0");
        timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    function updateProgress() {
        const total = parseInt(durationSelect.value) * 60;
        const percent = ((total - timeLeft) / total) * 100;
        progressBar.style.width = `${percent}%`;
    }

    // Geçmiş oturumları temizle
    document.getElementById("clearSessions")?.addEventListener("click", () => {
        if (confirm("Geçmiş oturumları silmek istediğine emin misin?")) {
            fetch("/pomodoro/clear_sessions/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                }
            }).then(() => location.reload());
        }
    });
});
</script>

{% endblock %}
