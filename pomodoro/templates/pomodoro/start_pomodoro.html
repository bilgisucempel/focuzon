{% extends "base.html" %}
{% load static %}
{% block title %}Start Pomodoro | Focuzon{% endblock %}
{% block body_class %}pomodoro-page{% endblock %}

{% block content %}
<div class="mt-20 bg-white/30 dark:bg-white/10 backdrop-blur-md border border-white/30 rounded-2xl shadow-xl p-10 max-w-md mx-auto text-center">
  <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Pomodoro Timer</h2>
  <p class="text-gray-700 dark:text-gray-300 text-sm mb-6">Choose your focus duration and stay productive!</p>

  <form method="POST" id="pomodoro-form" class="space-y-4 text-left">
    {% csrf_token %}
    <label for="id_duration" class="block text-gray-800 dark:text-white font-semibold">Select Duration:</label>
    <select id="id_duration" name="duration" class="w-full p-2 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white">
      <option value="">-- Select Time --</option>
      <option value="5">5 Minutes</option>
      <option value="10">10 Minutes</option>
      <option value="15">15 Minutes</option>
      <option value="20">20 Minutes</option>
      <option value="25">25 Minutes</option>
      <option value="30">30 Minutes</option>
      <option value="35">35 Minutes</option>
      <option value="40">40 Minutes</option>
      <option value="45">45 Minutes</option>
      <option value="50">50 Minutes</option>
      <option value="55">55 Minutes</option>
      <option value="60">60 Minutes</option>
    </select>
    <button type="button" id="startBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-semibold transition">🚀 Start</button>
  </form>

  <h2 id="timer" class="text-gray-900 dark:text-white text-3xl font-bold mt-6">00:00</h2>

  <div class="controls mt-4 space-y-3">
    <button id="pauseBtn" class="w-full bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 dark:hover:bg-purple-800 text-purple-800 dark:text-white py-2 rounded-lg font-semibold transition" style="display: none;">⏸ Pause</button>
    <button id="resumeBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 rounded-lg font-semibold transition" style="display: none;">▶ Resume</button>
    <button id="completeBtn" class="w-full bg-purple-300 dark:bg-purple-700 hover:bg-purple-400 dark:hover:bg-purple-600 text-white py-2 rounded-lg font-semibold transition" style="display: none;">🛑 End Session</button>
  </div>

  <div class="progress w-full h-4 bg-white/30 rounded-lg overflow-hidden mt-6">
    <div id="progressBar" class="progress-bar h-full bg-purple-400 transition-all duration-300" role="progressbar"></div>
  </div>

  <div id="successMessage" class="text-purple-500 text-center mt-5 text-lg font-medium" style="display:none;">
    🎉 Well done! You’ve completed your session.
  </div>

  <div class="history text-gray-800 dark:text-white mt-10 text-sm text-left">
    <h3 class="text-lg font-semibold mb-3">📜 Session History</h3>
    <ul class="space-y-1">
      {% for session in past_sessions %}
        <li>
           {{ session.start_time|date:"d M Y H:i" }} - {{ session.duration }} focused ({{ session.formatted_duration }})
        </li>
      {% empty %}
        <li>No previous sessions found.</li>
      {% endfor %}
    </ul>
    <button id="clearSessions" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-semibold transition mt-4">Clear Session History</button>
    <a href="{% url 'dashboard' %}" class="w-full inline-block bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-semibold transition mt-3 text-center">📊 Go to Dashboard</a>
  </div>
</div>

<input type="hidden" id="session_id" value="">



    <script>
let timer;
let timeLeft = 0;
let elapsedTime = 0;
let isRunning = false;
let sessionId = null;
let totalDuration = 0;
let startTimestamp = null;
// Başlangıçta seçilen süre (saniye cinsinden)


function updateDisplay() {
    let minutes = Math.floor(timeLeft / 60);
    let seconds = timeLeft % 60;
    const formatted = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

    document.getElementById("timer").textContent = formatted;
    document.title = `⏳ ${formatted} - Focuzon`; // sekme başlığı da burada
}

function updateProgressBar() {
    if (totalDuration > 0) {
        const progressPercent = ((totalDuration - timeLeft) / totalDuration) * 100;
        console.log("progress: ", progressPercent); // 🪵 log eklendi
        document.getElementById("progressBar").style.width = `${progressPercent}%`;
    } else {
        console.log("totalDuration not set"); // debug için
    }
}

function startCountdown() {
    if (!startTimestamp) {
        startTimestamp = Date.now(); // sadece ilk defa başlarken ayarla
    }
    clearInterval(timer);
    const endTime = Date.now() + timeLeft * 1000; // 🕒 bitiş zamanını hesapla

    timer = setInterval(() => {
        const now = Date.now();
        timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
        elapsedTime++
        updateDisplay();
        updateProgressBar();

        if (timeLeft <= 0) {
            clearInterval(timer);
            alert("Süre doldu!");
            document.getElementById("completeBtn").click();
        }
    }, 1000);
}

// ✅ SAYFA YENİLENİNCE AKTİF OTURUM VARSA GERİ YÜKLE
window.addEventListener("DOMContentLoaded", function () {
    fetch("/pomodoro/get_active/")
        .then(response => response.json())
        .then(data => {
            if (data.status === "active" && data.remaining_time > 0) {
                timeLeft = data.remaining_time;
                totalDuration = data.total_duration || data.remaining_time;
                elapsedTime = 0;
                sessionId = data.session_id;
                document.getElementById("session_id").value = sessionId;

                startTimestamp = new Date(data.start_time).getTime();



                updateDisplay();

                document.getElementById("startBtn").style.display = "none";
                document.getElementById("pauseBtn").style.display = "block";
                document.getElementById("completeBtn").style.display = "block";

                startCountdown();
            }
        });
});

document.getElementById("startBtn")?.addEventListener("click", function () {
    const durationSelect = document.querySelector("#id_duration");
    if (durationSelect && durationSelect.value) {
        timeLeft = parseInt(durationSelect.value) * 60;
        totalDuration = timeLeft;

        elapsedTime = 0;
        updateDisplay();

        document.getElementById("startBtn").style.display = "none";
        document.getElementById("pauseBtn").style.display = "block";
        document.getElementById("completeBtn").style.display = "block";

        fetch("/pomodoro/start/", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ duration: durationSelect.value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "started") {
                sessionId = data.session_id;
                document.getElementById("session_id").value = sessionId;
                startCountdown();
            } else {
                alert(data.message || "Oturum başlatılamadı!");
            }
        });
    } else {
        alert("Lütfen bir süre seç!");
    }
});

document.getElementById("pauseBtn")?.addEventListener("click", function () {
    clearInterval(timer);
    document.getElementById("pauseBtn").style.display = "none";
    document.getElementById("resumeBtn").style.display = "block";
});

document.getElementById("resumeBtn")?.addEventListener("click", function () {
    document.getElementById("resumeBtn").style.display = "none";
    document.getElementById("pauseBtn").style.display = "block";
    startCountdown();
});

document.getElementById("completeBtn")?.addEventListener("click", function () {
    clearInterval(timer);

    const hiddenId = document.getElementById("session_id").value;
    const finalSessionId = hiddenId || sessionId;

    if (!finalSessionId) {
        alert("Hata: Oturum ID bulunamadı!");
        return;
    }

    // Gerçek süre hesapla (fallback olarak elapsedTime)
    let actualElapsed = elapsedTime;
    if (startTimestamp) {
        actualElapsed = Math.floor((Date.now() - startTimestamp) / 1000);
    }

    fetch(`/pomodoro/complete/${finalSessionId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ elapsed_time: actualElapsed })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "completed") {
            alert("Çalışma tamamlandı! Süren kaydedildi.");
            window.location.href = "{% url 'start_pomodoro' %}";
        } else {
            alert("Hata: " + data.message);
        }
    });
});

document.getElementById("clearSessions").addEventListener("click", function() {
    if (confirm("Geçmiş oturumlarınızı silmek istediğinizden emin misiniz?")) {
        fetch("/pomodoro/clear_sessions/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                alert("Geçmiş oturumlar başarıyla silindi.");
                window.location.reload();  // Sayfayı yenileyerek değişiklikleri gösteriyoruz
            } else {
                alert("Bir hata oluştu. Lütfen tekrar deneyin.");
            }
        })
        .catch(error => {
            console.error("Bir hata oluştu:", error);
            alert("Bir hata oluştu, tekrar deneyin.");
        });
    }


});



</script>



{% endblock %}
